<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft Invaders</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            background: linear-gradient(to bottom, #87CEEB 0%, #228B22 100%);
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            box-sizing: border-box;
        }

        .main-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            max-width: 100vw;
            max-height: 100vh;
            box-sizing: border-box;
        }

        .game-container {
            background: #000;
            border: 4px solid #444;
            position: relative;
            width: min(1000px, 70vw);
            height: min(700px, 80vh);
            overflow: hidden;
            flex-shrink: 0;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 4px solid #444;
            border-radius: 10px;
            padding: 15px;
            width: min(220px, 25vw);
            max-height: min(700px, 80vh);
            color: #fff;
            font-size: 13px;
            overflow-y: auto;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .control-section {
            margin-bottom: 25px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 2px solid #666;
        }

        .control-section h3 {
            margin: 0 0 10px 0;
            color: #ffff00;
            font-size: 16px;
            text-align: center;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .control-title {
            color: #00ff00;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .game-canvas {
            width: 100%;
            height: 100%;
            position: relative;
            background: linear-gradient(to bottom, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .score {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #fff;
            font-size: 20px;
            z-index: 100;
        }

        .lives {
            position: absolute;
            top: 10px;
            right: 10px;
            color: #fff;
            font-size: 20px;
            z-index: 100;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-size: 36px;
            text-align: center;
            z-index: 200;
            display: none;
        }

        .instructions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 14px;
            text-align: center;
            z-index: 100;
        }

        .sprite {
            position: absolute;
            image-rendering: pixelated;
        }

        .player {
            width: 100px;
            height: 80px;
        }

        .enemy {
            width: 60px;
            height: 60px;
        }

        .projectile {
            width: 16px;
            height: 24px;
        }

        .enemy-projectile {
            width: 20px;
            height: 20px;
        }

        .fire-spread {
            width: 24px;
            height: 24px;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .slider-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .slider {
            width: 120px;
            height: 25px;
            background: #333;
            border: 2px solid #666;
            border-radius: 5px;
            outline: none;
            opacity: 0.8;
            cursor: pointer;
        }

        .slider:hover {
            opacity: 1;
        }

        .slider-value {
            background: rgba(0, 0, 0, 0.5);
            padding: 3px 8px;
            border-radius: 3px;
            border: 1px solid #888;
            min-width: 30px;
            text-align: center;
        }

        .level-display {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 24px;
            z-index: 100;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .powerup {
            width: 40px;
            height: 40px;
        }

        .powerup-indicator {
            position: absolute;
            top: 60px;
            left: 10px;
            color: #fff;
            font-size: 14px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 5px;
            border: 2px solid #444;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="game-container">
            <div class="game-canvas" id="gameCanvas">
                <div class="score">Score: <span id="score">0</span></div>
                <div class="lives">Lives: <span id="lives">3</span></div>
                <div class="level-display">Level <span id="level">1</span></div>
                
                <div class="powerup-indicator" id="powerupIndicator" style="display: none;">
                    Active: <span id="activePowerup"></span>
                </div>
                
                <div class="game-over" id="gameOver">
                    <div>GAME OVER</div>
                    <div style="font-size: 18px; margin-top: 10px;">Press R to restart</div>
                </div>
                <div class="instructions">
                    Use arrow keys to move ‚Ä¢ Spacebar to shoot fire ‚Ä¢ Defeat all hostile mobs!
                </div>
            </div>
        </div>
        
        <div class="control-panel">
            <div class="control-title">GAME CONTROLS</div>
            
            <div class="control-section">
                <h3>‚öîÔ∏è Difficulty</h3>
                <div class="slider-container">
                    <div class="slider-row">
                        <label>Snowball Rate:</label>
                        <span id="snowballValue" class="slider-value">1.0x</span>
                    </div>
                    <input type="range" id="snowballSlider" class="slider" min="0.1" max="2" step="0.1" value="1">
                </div>
            </div>
            
            <div class="control-section">
                <h3>üìä Statistics</h3>
                <div class="stat-row">
                    <span>High Score:</span>
                    <span id="highScore">0</span>
                </div>
                <div class="stat-row">
                    <span>Wins:</span>
                    <span id="wins">0</span>
                </div>
                <div class="stat-row">
                    <span>Losses:</span>
                    <span id="losses">0</span>
                </div>
            </div>
            
            <div class="control-section">
                <h3>üéÆ Controls</h3>
                <div style="font-size: 12px; line-height: 1.4;">
                    <div>üîÑ Arrow Keys: Move</div>
                    <div>üî• Spacebar: Shoot Fire</div>
                    <div>üîÑ R: Restart Game</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game statistics
        let gameStats = {
            highScore: parseInt(localStorage.getItem('minecraftInvadersHighScore')) || 0,
            wins: parseInt(localStorage.getItem('minecraftInvadersWins')) || 0,
            losses: parseInt(localStorage.getItem('minecraftInvadersLosses')) || 0
        };

        // Power-up system
        const powerUps = {
            active: {},
            items: [],
            types: {
                goldenApple: { name: 'Golden Apple', duration: 5000, effect: 'invincibility' },
                firePotion: { name: 'Fire Potion', duration: 20000, effect: 'rapidFire' },
                totem: { name: 'Totem of Undying', duration: 0, effect: 'extraLife' },
                redstone: { name: 'Redstone', duration: 15000, effect: 'slowEnemies' },
                tnt: { name: 'TNT', duration: 0, effect: 'explosion' },
                blazeRod: { name: 'Blaze Rod', duration: 25000, effect: 'spreadingFire' }
            }
        };

        // Game state
        const game = {
            canvas: document.getElementById('gameCanvas'),
            player: null,
            enemies: [],
            projectiles: [],
            enemyProjectiles: [],
            score: 0,
            lives: 3,
            gameRunning: true,
            keys: {},
            lastShot: 0,
            enemyDirection: 1,
            enemySpeed: 1,
            level: 1,
            snowballFrequency: 1,
            enemiesDefeated: 0,
            totalEnemiesInLevel: 0,
            lastPowerUpSpawn: 0,
            nextExplosiveShot: false,
            fireSpreadEffects: []
        };

        // Initialize UI
        function initUI() {
            document.getElementById('highScore').textContent = gameStats.highScore;
            document.getElementById('wins').textContent = gameStats.wins;
            document.getElementById('losses').textContent = gameStats.losses;
            document.getElementById('level').textContent = game.level;
            
            // Snowball slider event
            const slider = document.getElementById('snowballSlider');
            slider.addEventListener('input', (e) => {
                game.snowballFrequency = parseFloat(e.target.value);
                document.getElementById('snowballValue').textContent = game.snowballFrequency.toFixed(1) + 'x';
            });
        }

        // Save statistics
        function saveStats() {
            localStorage.setItem('minecraftInvadersHighScore', gameStats.highScore);
            localStorage.setItem('minecraftInvadersWins', gameStats.wins);
            localStorage.setItem('minecraftInvadersLosses', gameStats.losses);
        }

        // Update high score
        function updateHighScore() {
            if (game.score > gameStats.highScore) {
                gameStats.highScore = game.score;
                document.getElementById('highScore').textContent = gameStats.highScore;
                saveStats();
            }
        }

        // Sound effects using Web Audio API
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playSound(frequency, duration, type = 'square') {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = frequency;
            oscillator.type = type;
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }
        
        const sounds = {
            shoot: () => playSound(800, 0.1),
            hit: () => {
                // Create a crash sound with multiple frequencies and noise
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const oscillator3 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                oscillator3.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Multiple harsh frequencies for crash effect
                oscillator1.frequency.value = 100;
                oscillator2.frequency.value = 80;
                oscillator3.frequency.value = 60;
                
                // Use sawtooth wave for harsher sound
                oscillator1.type = 'sawtooth';
                oscillator2.type = 'square';
                oscillator3.type = 'triangle';
                
                // Sharp attack and quick decay for crash effect
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                
                const startTime = audioContext.currentTime;
                const duration = 0.4;
                
                oscillator1.start(startTime);
                oscillator2.start(startTime);
                oscillator3.start(startTime);
                
                oscillator1.stop(startTime + duration);
                oscillator2.stop(startTime + duration);
                oscillator3.stop(startTime + duration);
            },
            enemyHit: () => playSound(150, 0.3),
            gameOver: () => {
                // Create a long, dramatic explosion sound effect
                const duration = 3.0; // 3 second explosion
                const startTime = audioContext.currentTime;
                
                // Initial explosion blast - sharp attack
                const blastOsc = audioContext.createOscillator();
                const blastGain = audioContext.createGain();
                
                blastOsc.connect(blastGain);
                blastGain.connect(audioContext.destination);
                
                blastOsc.frequency.value = 80;
                blastOsc.type = 'sawtooth';
                
                // Sharp explosion attack
                blastGain.gain.setValueAtTime(0.4, startTime);
                blastGain.gain.exponentialRampToValueAtTime(0.1, startTime + 0.2);
                blastGain.gain.exponentialRampToValueAtTime(0.01, startTime + 1.0);
                
                blastOsc.start(startTime);
                blastOsc.stop(startTime + 1.0);
                
                // Rumbling bass frequencies
                for (let i = 0; i < 3; i++) {
                    const rumbleOsc = audioContext.createOscillator();
                    const rumbleGain = audioContext.createGain();
                    
                    rumbleOsc.connect(rumbleGain);
                    rumbleGain.connect(audioContext.destination);
                    
                    rumbleOsc.frequency.value = 40 + (i * 20); // 40, 60, 80 Hz
                    rumbleOsc.type = 'square';
                    
                    const rumbleStart = startTime + (i * 0.1);
                    rumbleGain.gain.setValueAtTime(0.2 - (i * 0.05), rumbleStart);
                    rumbleGain.gain.exponentialRampToValueAtTime(0.01, rumbleStart + duration);
                    
                    rumbleOsc.start(rumbleStart);
                    rumbleOsc.stop(rumbleStart + duration);
                }
                
                // High-frequency crackling/debris sounds
                for (let i = 0; i < 5; i++) {
                    const crackleOsc = audioContext.createOscillator();
                    const crackleGain = audioContext.createGain();
                    
                    crackleOsc.connect(crackleGain);
                    crackleGain.connect(audioContext.destination);
                    
                    crackleOsc.frequency.value = 200 + Math.random() * 300; // Random high frequencies
                    crackleOsc.type = 'triangle';
                    
                    const crackleStart = startTime + 0.3 + (i * 0.2);
                    const crackleDuration = 0.15 + Math.random() * 0.2;
                    
                    crackleGain.gain.setValueAtTime(0.05, crackleStart);
                    crackleGain.gain.exponentialRampToValueAtTime(0.01, crackleStart + crackleDuration);
                    
                    crackleOsc.start(crackleStart);
                    crackleOsc.stop(crackleStart + crackleDuration);
                }
                
                // Final echo/reverb effect
                const echoOsc = audioContext.createOscillator();
                const echoGain = audioContext.createGain();
                
                echoOsc.connect(echoGain);
                echoGain.connect(audioContext.destination);
                
                echoOsc.frequency.value = 100;
                echoOsc.type = 'sine';
                
                echoGain.gain.setValueAtTime(0, startTime + 1.5);
                echoGain.gain.linearRampToValueAtTime(0.08, startTime + 1.8);
                echoGain.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
                
                echoOsc.start(startTime + 1.5);
                echoOsc.stop(startTime + duration);
            }
        };

        // Sprite definitions using SVG
        const sprites = {
            chicken: `
                <svg width="100" height="80" viewBox="0 0 100 80">
                    <!-- Chicken head -->
                    <rect x="35" y="10" width="30" height="25" fill="#FFFFFF"/>
                    <rect x="30" y="15" width="40" height="15" fill="#F0F0F0"/>
                    <!-- Beak -->
                    <rect x="25" y="20" width="10" height="8" fill="#FFA500"/>
                    <rect x="20" y="22" width="8" height="4" fill="#FF8C00"/>
                    <!-- Eyes -->
                    <rect x="40" y="18" width="6" height="6" fill="#000000"/>
                    <rect x="54" y="18" width="6" height="6" fill="#000000"/>
                    <rect x="42" y="20" width="2" height="2" fill="#FFFFFF"/>
                    <rect x="56" y="20" width="2" height="2" fill="#FFFFFF"/>
                    <!-- Comb (red crest on top) -->
                    <rect x="42" y="5" width="6" height="8" fill="#DC143C"/>
                    <rect x="48" y="3" width="6" height="10" fill="#DC143C"/>
                    <rect x="54" y="5" width="6" height="8" fill="#DC143C"/>
                    <!-- Wattles (red things under beak) -->
                    <rect x="30" y="28" width="4" height="6" fill="#DC143C"/>
                    <rect x="66" y="28" width="4" height="6" fill="#DC143C"/>
                    <!-- Body -->
                    <rect x="25" y="35" width="50" height="30" fill="#FFFFFF"/>
                    <rect x="20" y="40" width="60" height="20" fill="#F5F5F5"/>
                    <!-- Wings -->
                    <rect x="15" y="42" width="15" height="16" fill="#E0E0E0"/>
                    <rect x="70" y="42" width="15" height="16" fill="#E0E0E0"/>
                    <!-- Tail feathers -->
                    <rect x="75" y="35" width="20" height="25" fill="#DCDCDC"/>
                    <rect x="80" y="30" width="15" height="20" fill="#FFFFFF"/>
                    <!-- Legs -->
                    <rect x="38" y="65" width="6" height="12" fill="#FFA500"/>
                    <rect x="56" y="65" width="6" height="12" fill="#FFA500"/>
                    <!-- Feet -->
                    <rect x="32" y="75" width="18" height="4" fill="#FF8C00"/>
                    <rect x="50" y="75" width="18" height="4" fill="#FF8C00"/>
                </svg>
            `,
            zombie: `
                <svg width="60" height="60" viewBox="0 0 60 60">
                    <!-- Head -->
                    <rect x="15" y="5" width="30" height="25" fill="#7cb518"/>
                    <rect x="12" y="8" width="36" height="19" fill="#6ca017"/>
                    <!-- Face -->
                    <rect x="20" y="12" width="6" height="6" fill="#000"/>
                    <rect x="34" y="12" width="6" height="6" fill="#000"/>
                    <rect x="22" y="14" width="2" height="2" fill="#ff0000"/>
                    <rect x="36" y="14" width="2" height="2" fill="#ff0000"/>
                    <rect x="24" y="20" width="12" height="4" fill="#654321"/>
                    <rect x="26" y="22" width="2" height="2" fill="#fff"/>
                    <rect x="30" y="22" width="2" height="2" fill="#fff"/>
                    <rect x="34" y="22" width="2" height="2" fill="#fff"/>
                    <!-- Body -->
                    <rect x="18" y="30" width="24" height="20" fill="#3366cc"/>
                    <rect x="15" y="33" width="30" height="14" fill="#2d5ab8"/>
                    <!-- Arms -->
                    <rect x="6" y="32" width="12" height="18" fill="#7cb518"/>
                    <rect x="42" y="32" width="12" height="18" fill="#7cb518"/>
                    <!-- Legs -->
                    <rect x="20" y="50" width="8" height="10" fill="#654321"/>
                    <rect x="32" y="50" width="8" height="10" fill="#654321"/>
                </svg>
            `,
            creeper: `
                <svg width="60" height="60" viewBox="0 0 60 60">
                    <!-- Body -->
                    <rect x="15" y="10" width="30" height="50" fill="#0da70b"/>
                    <rect x="12" y="12" width="36" height="46" fill="#0b8f09"/>
                    <!-- Face -->
                    <rect x="18" y="16" width="6" height="6" fill="#000"/>
                    <rect x="36" y="16" width="6" height="6" fill="#000"/>
                    <rect x="20" y="18" width="2" height="2" fill="#333"/>
                    <rect x="38" y="18" width="2" height="2" fill="#333"/>
                    <!-- Mouth pattern -->
                    <rect x="24" y="24" width="6" height="6" fill="#000"/>
                    <rect x="30" y="24" width="6" height="6" fill="#000"/>
                    <rect x="27" y="30" width="6" height="10" fill="#000"/>
                    <!-- Texture details -->
                    <rect x="18" y="40" width="6" height="2" fill="#085c07"/>
                    <rect x="36" y="40" width="6" height="2" fill="#085c07"/>
                    <rect x="24" y="45" width="12" height="2" fill="#085c07"/>
                    <!-- Legs -->
                    <rect x="12" y="50" width="12" height="10" fill="#0da70b"/>
                    <rect x="36" y="50" width="12" height="10" fill="#0da70b"/>
                </svg>
            `,
            skeleton: `
                <svg width="60" height="60" viewBox="0 0 60 60">
                    <!-- Head -->
                    <rect x="18" y="5" width="24" height="20" fill="#f5f5dc"/>
                    <rect x="15" y="8" width="30" height="14" fill="#ede5c8"/>
                    <!-- Face -->
                    <rect x="22" y="12" width="4" height="6" fill="#000"/>
                    <rect x="34" y="12" width="4" height="6" fill="#000"/>
                    <rect x="24" y="14" width="2" height="2" fill="#333"/>
                    <rect x="36" y="14" width="2" height="2" fill="#333"/>
                    <rect x="26" y="18" width="8" height="3" fill="#000"/>
                    <rect x="28" y="19" width="1" height="1" fill="#f5f5dc"/>
                    <rect x="31" y="19" width="1" height="1" fill="#f5f5dc"/>
                    <!-- Body -->
                    <rect x="21" y="25" width="18" height="25" fill="#ddd"/>
                    <rect x="18" y="28" width="24" height="19" fill="#ccc"/>
                    <!-- Ribs -->
                    <rect x="24" y="30" width="12" height="2" fill="#aaa"/>
                    <rect x="24" y="34" width="12" height="2" fill="#aaa"/>
                    <rect x="24" y="38" width="12" height="2" fill="#aaa"/>
                    <!-- Arms -->
                    <rect x="9" y="27" width="12" height="15" fill="#ddd"/>
                    <rect x="39" y="27" width="12" height="15" fill="#ddd"/>
                    <!-- Legs -->
                    <rect x="22" y="50" width="6" height="10" fill="#ddd"/>
                    <rect x="32" y="50" width="6" height="10" fill="#ddd"/>
                </svg>
            `,
            enderman: `
                <svg width="60" height="60" viewBox="0 0 60 60">
                    <!-- Head -->
                    <rect x="18" y="5" width="24" height="20" fill="#1a1a1a"/>
                    <rect x="15" y="8" width="30" height="14" fill="#0f0f0f"/>
                    <!-- Eyes -->
                    <rect x="22" y="12" width="4" height="8" fill="#ff00ff"/>
                    <rect x="34" y="12" width="4" height="8" fill="#ff00ff"/>
                    <rect x="23" y="14" width="2" height="4" fill="#ffffff"/>
                    <rect x="35" y="14" width="2" height="4" fill="#ffffff"/>
                    <!-- Body -->
                    <rect x="24" y="25" width="12" height="25" fill="#1a1a1a"/>
                    <rect x="21" y="28" width="18" height="19" fill="#0f0f0f"/>
                    <!-- Arms (extra long) -->
                    <rect x="12" y="30" width="9" height="25" fill="#1a1a1a"/>
                    <rect x="39" y="30" width="9" height="25" fill="#1a1a1a"/>
                    <!-- Legs (extra long) -->
                    <rect x="26" y="50" width="4" height="15" fill="#1a1a1a"/>
                    <rect x="30" y="50" width="4" height="15" fill="#1a1a1a"/>
                    <!-- Purple particles effect -->
                    <rect x="10" y="20" width="2" height="2" fill="#8A2BE2" opacity="0.7"/>
                    <rect x="48" y="25" width="2" height="2" fill="#8A2BE2" opacity="0.7"/>
                    <rect x="15" y="45" width="2" height="2" fill="#8A2BE2" opacity="0.7"/>
                    <rect x="43" y="40" width="2" height="2" fill="#8A2BE2" opacity="0.7"/>
                </svg>
            `,
            fire: `
                <svg width="16" height="24" viewBox="0 0 16 24">
                    <rect x="6" y="0" width="4" height="6" fill="#ffff00"/>
                    <rect x="4" y="6" width="8" height="6" fill="#ff8800"/>
                    <rect x="2" y="12" width="12" height="6" fill="#ff4400"/>
                    <rect x="4" y="18" width="8" height="6" fill="#ff0000"/>
                    <!-- Fire flicker effect -->
                    <rect x="7" y="2" width="2" height="2" fill="#ffffff"/>
                    <rect x="5" y="8" width="2" height="2" fill="#ffaa00"/>
                    <rect x="9" y="8" width="2" height="2" fill="#ffaa00"/>
                </svg>
            `,
            snowball: `
                <svg width="20" height="20" viewBox="0 0 20 20">
                    <rect x="4" y="4" width="12" height="12" fill="#ffffff"/>
                    <rect x="6" y="2" width="8" height="8" fill="#f0f0f0"/>
                    <rect x="2" y="6" width="8" height="8" fill="#f0f0f0"/>
                    <rect x="10" y="6" width="8" height="8" fill="#f0f0f0"/>
                    <rect x="6" y="10" width="8" height="8" fill="#f0f0f0"/>
                    <!-- Snow texture -->
                    <rect x="8" y="8" width="4" height="4" fill="#e8e8e8"/>
                    <rect x="6" y="6" width="2" height="2" fill="#ddd"/>
                    <rect x="12" y="12" width="2" height="2" fill="#ddd"/>
                </svg>
            `,
            diamondSword: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="18" y="4" width="4" height="24" fill="#8B4513"/>
                    <rect x="16" y="28" width="8" height="4" fill="#654321"/>
                    <rect x="14" y="2" width="12" height="20" fill="#87CEEB"/>
                    <rect x="16" y="0" width="8" height="4" fill="#B0E0E6"/>
                    <rect x="18" y="6" width="4" height="12" fill="#E0FFFF"/>
                </svg>
            `,
            goldenApple: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="16" y="8" width="8" height="24" fill="#FFD700"/>
                    <rect x="12" y="12" width="16" height="16" fill="#FFA500"/>
                    <rect x="18" y="4" width="4" height="8" fill="#228B22"/>
                    <rect x="14" y="14" width="12" height="12" fill="#FFFF00" opacity="0.7"/>
                    <rect x="20" y="10" width="4" height="4" fill="#ADFF2F"/>
                </svg>
            `,
            enderPearl: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="12" y="12" width="16" height="16" fill="#2F2F4F"/>
                    <rect x="14" y="10" width="12" height="20" fill="#483D8B"/>
                    <rect x="16" y="8" width="8" height="24" fill="#6A5ACD"/>
                    <rect x="18" y="14" width="4" height="12" fill="#9370DB" opacity="0.8"/>
                    <rect x="10" y="18" width="2" height="2" fill="#DDA0DD" opacity="0.6"/>
                    <rect x="28" y="22" width="2" height="2" fill="#DDA0DD" opacity="0.6"/>
                </svg>
            `,
            firePotion: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="14" y="8" width="12" height="24" fill="#8B4513"/>
                    <rect x="16" y="10" width="8" height="20" fill="#FF4500"/>
                    <rect x="18" y="12" width="4" height="16" fill="#FF6347"/>
                    <rect x="16" y="4" width="8" height="8" fill="#696969"/>
                    <rect x="18" y="6" width="4" height="4" fill="#A9A9A9"/>
                    <rect x="20" y="14" width="2" height="2" fill="#FFFF00" opacity="0.8"/>
                </svg>
            `,
            totem: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="16" y="8" width="8" height="24" fill="#FFD700"/>
                    <rect x="12" y="12" width="16" height="16" fill="#FFA500"/>
                    <rect x="14" y="4" width="12" height="8" fill="#32CD32"/>
                    <rect x="18" y="2" width="4" height="6" fill="#228B22"/>
                    <rect x="18" y="14" width="4" height="12" fill="#FFFF00" opacity="0.7"/>
                    <rect x="10" y="16" width="4" height="8" fill="#FFD700"/>
                    <rect x="26" y="16" width="4" height="8" fill="#FFD700"/>
                </svg>
            `,
            redstone: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="14" y="14" width="12" height="12" fill="#DC143C"/>
                    <rect x="16" y="12" width="8" height="16" fill="#FF0000"/>
                    <rect x="12" y="16" width="16" height="8" fill="#B22222"/>
                    <rect x="18" y="18" width="4" height="4" fill="#FF6347" opacity="0.8"/>
                    <rect x="8" y="20" width="2" height="2" fill="#FF0000" opacity="0.6"/>
                    <rect x="30" y="18" width="2" height="2" fill="#FF0000" opacity="0.6"/>
                    <rect x="20" y="8" width="2" height="2" fill="#FF0000" opacity="0.6"/>
                </svg>
            `,
            tnt: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="8" y="8" width="24" height="24" fill="#DC143C"/>
                    <rect x="10" y="10" width="20" height="20" fill="#FF0000"/>
                    <rect x="12" y="12" width="16" height="16" fill="#8B0000"/>
                    <rect x="14" y="18" width="12" height="4" fill="#FFFFFF"/>
                    <rect x="18" y="14" width="4" height="12" fill="#FFFFFF"/>
                    <rect x="16" y="4" width="8" height="8" fill="#228B22"/>
                    <rect x="20" y="2" width="2" height="6" fill="#000000"/>
                </svg>
            `,
            blazeRod: `
                <svg width="40" height="40" viewBox="0 0 40 40">
                    <rect x="18" y="4" width="4" height="32" fill="#8B4513"/>
                    <rect x="16" y="6" width="8" height="28" fill="#DAA520"/>
                    <rect x="14" y="8" width="12" height="24" fill="#FF8C00"/>
                    <rect x="16" y="10" width="8" height="20" fill="#FF4500"/>
                    <rect x="18" y="12" width="4" height="16" fill="#FF0000"/>
                    <!-- Fire particles -->
                    <rect x="12" y="14" width="2" height="2" fill="#FFD700" opacity="0.8"/>
                    <rect x="26" y="18" width="2" height="2" fill="#FFD700" opacity="0.8"/>
                    <rect x="10" y="22" width="2" height="2" fill="#FF6347" opacity="0.7"/>
                    <rect x="28" y="26" width="2" height="2" fill="#FF6347" opacity="0.7"/>
                </svg>
            `,
            fireSpread: `
                <svg width="24" height="24" viewBox="0 0 24 24">
                    <rect x="8" y="4" width="8" height="16" fill="#FF4500"/>
                    <rect x="6" y="6" width="12" height="12" fill="#FF6347"/>
                    <rect x="4" y="8" width="16" height="8" fill="#FF8C00"/>
                    <rect x="10" y="2" width="4" height="20" fill="#FFD700"/>
                    <rect x="12" y="0" width="2" height="24" fill="#FFFF00" opacity="0.8"/>
                    <!-- Animated flicker effect -->
                    <rect x="2" y="10" width="2" height="4" fill="#FF0000" opacity="0.6"/>
                    <rect x="20" y="8" width="2" height="6" fill="#FF0000" opacity="0.6"/>
                </svg>
            `
        };

        // Create sprite element
        function createSprite(type, x, y) {
            const sprite = document.createElement('div');
            sprite.className = `sprite ${type}`;
            sprite.style.left = x + 'px';
            sprite.style.top = y + 'px';
            sprite.innerHTML = sprites[type === 'player' ? 'chicken' : type];
            return sprite;
        }

        // Get canvas dimensions
        function getCanvasDimensions() {
            const canvas = document.getElementById('gameCanvas');
            return {
                width: canvas.offsetWidth,
                height: canvas.offsetHeight
            };
        }

        // Initialize player
        function initPlayer() {
            const canvasSize = getCanvasDimensions();
            game.player = {
                element: createSprite('player', (canvasSize.width - 100) / 2, canvasSize.height - 120),
                x: (canvasSize.width - 100) / 2,
                y: canvasSize.height - 120,
                speed: 6
            };
            game.canvas.appendChild(game.player.element);
        }

        // Create enemy wave
        function createEnemies() {
            const canvasSize = getCanvasDimensions();
            const enemyTypes = ['zombie', 'creeper', 'skeleton', 'enderman'];
            
            // Calculate grid based on canvas size
            const maxCols = Math.floor((canvasSize.width - 120) / 70);
            const maxRows = Math.floor((canvasSize.height * 0.4) / 60);
            
            // Ensure we always have at least 4 rows to include all enemy types
            const rows = Math.max(4, Math.min(3 + Math.floor(game.level / 3), maxRows));
            const cols = Math.max(6, Math.min(6 + Math.floor(game.level / 2), maxCols));
            
            game.totalEnemiesInLevel = rows * cols;
            game.enemiesDefeated = 0;
            
            // Center the enemy grid with tighter spacing
            const gridWidth = cols * 70;
            const startX = (canvasSize.width - gridWidth) / 2;
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const enemyType = enemyTypes[row % enemyTypes.length];
                    const enemy = {
                        element: createSprite('enemy', startX + col * 70, 60 + row * 60),
                        x: startX + col * 70,
                        y: 60 + row * 60,
                        type: enemyType,
                        lastShot: 0
                    };
                    enemy.element.innerHTML = sprites[enemyType];
                    game.enemies.push(enemy);
                    game.canvas.appendChild(enemy.element);
                }
            }
        }

        // Move player
        function movePlayer() {
            const canvasSize = getCanvasDimensions();
            const minY = canvasSize.height * 0.6; // Player can only move in bottom 40% of screen
            
            if (game.keys['ArrowLeft'] && game.player.x > 0) {
                game.player.x -= game.player.speed;
            }
            if (game.keys['ArrowRight'] && game.player.x < canvasSize.width - 100) {
                game.player.x += game.player.speed;
            }
            if (game.keys['ArrowUp'] && game.player.y > minY) {
                game.player.y -= game.player.speed;
            }
            if (game.keys['ArrowDown'] && game.player.y < canvasSize.height - 80) {
                game.player.y += game.player.speed;
            }
            
            game.player.element.style.left = game.player.x + 'px';
            game.player.element.style.top = game.player.y + 'px';
        }

        // Power-up functions
        function activatePowerUp(type) {
            const powerUp = powerUps.types[type];
            
            switch(powerUp.effect) {
                case 'invincibility':
                    powerUps.active.invincibility = Date.now() + powerUp.duration;
                    break;
                case 'rapidFire':
                    powerUps.active.rapidFire = Date.now() + powerUp.duration;
                    break;
                case 'extraLife':
                    game.lives++;
                    document.getElementById('lives').textContent = game.lives;
                    break;
                case 'slowEnemies':
                    powerUps.active.slowEnemies = Date.now() + powerUp.duration;
                    break;
                case 'explosion':
                    game.nextExplosiveShot = true;
                    break;
                case 'spreadingFire':
                    powerUps.active.spreadingFire = Date.now() + powerUp.duration;
                    break;
            }
            
            updatePowerUpDisplay();
        }
        
        function updatePowerUpDisplay() {
            const now = Date.now();
            const activeEffects = [];
            
            Object.keys(powerUps.active).forEach(effect => {
                if (powerUps.active[effect] > now) {
                    activeEffects.push(effect);
                } else {
                    delete powerUps.active[effect];
                }
            });
            
            if (game.nextExplosiveShot) activeEffects.push('TNT Ready');
            if (powerUps.active.spreadingFire && powerUps.active.spreadingFire > now) activeEffects.push('Spreading Fire');
            
            const indicator = document.getElementById('powerupIndicator');
            const display = document.getElementById('activePowerup');
            
            if (activeEffects.length > 0) {
                indicator.style.display = 'block';
                display.textContent = activeEffects.join(', ');
            } else {
                indicator.style.display = 'none';
            }
        }
        
        function spawnPowerUp() {
            const now = Date.now();
            if (now - game.lastPowerUpSpawn < 8000) return; // Minimum 8 seconds between spawns
            
            if (Math.random() < 0.25) { // 25% chance
                const canvasSize = getCanvasDimensions();
                const types = Object.keys(powerUps.types);
                const randomType = types[Math.floor(Math.random() * types.length)];
                
                const x = Math.random() * (canvasSize.width - 40);
                const powerUp = {
                    element: createSprite('powerup', x, -40),
                    x: x,
                    y: -40,
                    type: randomType,
                    speed: 2
                };
                
                powerUp.element.innerHTML = sprites[randomType];
                powerUps.items.push(powerUp);
                game.canvas.appendChild(powerUp.element);
                game.lastPowerUpSpawn = now;
                
                console.log('PowerUp spawned:', randomType, 'at', x, -40);
            }
        }
        
        function createFireSpreadEffect(startX, startY) {
            // Create multiple fire spread sprites that move outward
            const directions = [
                {x: -1, y: -1}, {x: 0, y: -1}, {x: 1, y: -1},
                {x: -1, y: 0},                 {x: 1, y: 0},
                {x: -1, y: 1},  {x: 0, y: 1},  {x: 1, y: 1}
            ];
            
            directions.forEach((dir, index) => {
                setTimeout(() => {
                    const fireSpread = {
                        element: createSprite('fire-spread', startX, startY),
                        x: startX,
                        y: startY,
                        vx: dir.x * 3, // velocity
                        vy: dir.y * 3,
                        life: 30, // frames to live
                        maxLife: 30
                    };
                    
                    fireSpread.element.innerHTML = sprites.fireSpread;
                    game.fireSpreadEffects.push(fireSpread);
                    game.canvas.appendChild(fireSpread.element);
                }, index * 50); // Stagger the creation
            });
        }
        
        function moveFireSpreadEffects() {
            for (let index = game.fireSpreadEffects.length - 1; index >= 0; index--) {
                const fire = game.fireSpreadEffects[index];
                if (!fire || !fire.element) continue;
                
                // Move the fire spread
                fire.x += fire.vx;
                fire.y += fire.vy;
                fire.life--;
                
                // Fade out over time
                const opacity = fire.life / fire.maxLife;
                fire.element.style.opacity = opacity;
                fire.element.style.left = fire.x + 'px';
                fire.element.style.top = fire.y + 'px';
                
                // Check collision with enemies
                for (let eIndex = game.enemies.length - 1; eIndex >= 0; eIndex--) {
                    const enemy = game.enemies[eIndex];
                    if (!enemy || !enemy.element) continue;
                    
                    const distance = Math.sqrt(
                        Math.pow(fire.x - enemy.x, 2) + 
                        Math.pow(fire.y - enemy.y, 2)
                    );
                    
                    if (distance < 40) {
                        // Destroy enemy
                        if (enemy.element && enemy.element.parentNode) {
                            game.canvas.removeChild(enemy.element);
                        }
                        
                        let points = 75 + (game.level - 1) * 7; // Spread fire points
                        if (enemy.type === 'enderman') points = 150 + (game.level - 1) * 15;
                        else if (enemy.type === 'creeper') points = 112 + (game.level - 1) * 11;
                        
                        game.score += points;
                        game.enemiesDefeated++;
                        game.enemies.splice(eIndex, 1);
                        document.getElementById('score').textContent = game.score;
                        updateHighScore();
                        
                        // Create secondary fire spread from this enemy
                        if (Math.random() < 0.3) { // 30% chance to spread further
                            createFireSpreadEffect(enemy.x + 20, enemy.y + 20);
                        }
                        
                        sounds.enemyHit();
                        break;
                    }
                }
                
                // Remove fire spread when life expires
                if (fire.life <= 0) {
                    if (fire.element && fire.element.parentNode) {
                        game.canvas.removeChild(fire.element);
                    }
                    game.fireSpreadEffects.splice(index, 1);
                }
            }
        }
        
        function movePowerUps() {
            for (let index = powerUps.items.length - 1; index >= 0; index--) {
                const powerUp = powerUps.items[index];
                if (!powerUp || !powerUp.element) continue;
                
                powerUp.y += powerUp.speed;
                powerUp.element.style.top = powerUp.y + 'px';
                
                const canvasSize = getCanvasDimensions();
                if (powerUp.y > canvasSize.height) {
                    if (powerUp.element && powerUp.element.parentNode) {
                        game.canvas.removeChild(powerUp.element);
                    }
                    powerUps.items.splice(index, 1);
                }
            }
        }
        

        // Shoot projectile
        function shoot() {
            const now = Date.now();
            const fireRate = powerUps.active.rapidFire && powerUps.active.rapidFire > now ? 66 : 200; // 3x faster with rapid fire
            
            if (now - game.lastShot > fireRate) {
                const projectile = {
                    element: createSprite('projectile', game.player.x + 42, game.player.y),
                    x: game.player.x + 42,
                    y: game.player.y,
                    speed: 10,
                    explosive: game.nextExplosiveShot
                };
                
                if (game.nextExplosiveShot) {
                    game.nextExplosiveShot = false;
                    updatePowerUpDisplay();
                }
                
                projectile.element.innerHTML = sprites.fire;
                game.projectiles.push(projectile);
                game.canvas.appendChild(projectile.element);
                game.lastShot = now;
                sounds.shoot();
            }
        }

        // Enemy shooting
        function enemyShoot() {
            const now = Date.now();
            const baseChance = 0.001 * game.snowballFrequency;
            game.enemies.forEach(enemy => {
                if (now - enemy.lastShot > 2000 && Math.random() < baseChance) {
                    const projectile = {
                        element: createSprite('enemy-projectile', enemy.x + 20, enemy.y + 60),
                        x: enemy.x + 20,
                        y: enemy.y + 60,
                        speed: 4
                    };
                    projectile.element.innerHTML = sprites.snowball;
                    game.enemyProjectiles.push(projectile);
                    game.canvas.appendChild(projectile.element);
                    enemy.lastShot = now;
                }
            });
        }

        // Move enemies
        function moveEnemies() {
            const canvasSize = getCanvasDimensions();
            let changeDirection = false;
            
            // Apply slow effect if redstone power-up is active
            const now = Date.now();
            const speedMultiplier = (powerUps.active.slowEnemies && powerUps.active.slowEnemies > now) ? 0.3 : 1;
            
            game.enemies.forEach(enemy => {
                if (enemy.x <= 0 || enemy.x >= canvasSize.width - 60) {
                    changeDirection = true;
                }
            });
            
            if (changeDirection) {
                game.enemyDirection *= -1;
                game.enemies.forEach(enemy => {
                    enemy.y += 30 * speedMultiplier;
                    enemy.element.style.top = enemy.y + 'px';
                });
            }
            
            game.enemies.forEach(enemy => {
                enemy.x += game.enemyDirection * game.enemySpeed * speedMultiplier;
                enemy.element.style.left = enemy.x + 'px';
            });
        }

        // Move projectiles
        function moveProjectiles() {
            // Player projectiles - iterate backwards
            for (let index = game.projectiles.length - 1; index >= 0; index--) {
                const projectile = game.projectiles[index];
                if (!projectile || !projectile.element) continue;
                
                projectile.y -= projectile.speed;
                projectile.element.style.top = projectile.y + 'px';
                
                if (projectile.y < 0) {
                    if (projectile.element && projectile.element.parentNode) {
                        game.canvas.removeChild(projectile.element);
                    }
                    game.projectiles.splice(index, 1);
                }
            }
            
            // Enemy projectiles - iterate backwards
            for (let index = game.enemyProjectiles.length - 1; index >= 0; index--) {
                const projectile = game.enemyProjectiles[index];
                if (!projectile || !projectile.element) continue;
                
                projectile.y += projectile.speed;
                projectile.element.style.top = projectile.y + 'px';
                
                const canvasSize = getCanvasDimensions();
                if (projectile.y > canvasSize.height) {
                    if (projectile.element && projectile.element.parentNode) {
                        game.canvas.removeChild(projectile.element);
                    }
                    game.enemyProjectiles.splice(index, 1);
                }
            }
        }

        // Collision detection
        function checkCollisions() {
            // Debug: Check if we have power-ups and player
            if (powerUps.items.length > 0 && game.player) {
                // console.log('Checking collisions with', powerUps.items.length, 'power-ups');
            }
            
            // Player projectiles vs enemies - iterate backwards to avoid index issues
            for (let pIndex = game.projectiles.length - 1; pIndex >= 0; pIndex--) {
                const projectile = game.projectiles[pIndex];
                if (!projectile || !projectile.element) continue;
                
                for (let eIndex = game.enemies.length - 1; eIndex >= 0; eIndex--) {
                    const enemy = game.enemies[eIndex];
                    if (!enemy || !enemy.element) continue;
                    
                    if (projectile.x < enemy.x + 60 &&
                        projectile.x + 16 > enemy.x &&
                        projectile.y < enemy.y + 60 &&
                        projectile.y + 24 > enemy.y) {
                        
                        // Handle explosive shots (TNT power-up)
                        if (projectile.explosive) {
                            // Destroy enemies in explosion radius
                            for (let i = game.enemies.length - 1; i >= 0; i--) {
                                const targetEnemy = game.enemies[i];
                                const distance = Math.sqrt(
                                    Math.pow(enemy.x - targetEnemy.x, 2) + 
                                    Math.pow(enemy.y - targetEnemy.y, 2)
                                );
                                
                                if (distance < 120) { // Explosion radius
                                    if (targetEnemy.element && targetEnemy.element.parentNode) {
                                        game.canvas.removeChild(targetEnemy.element);
                                    }
                                    
                                    let points = 100 + (game.level - 1) * 10;
                                    if (targetEnemy.type === 'enderman') points = 200 + (game.level - 1) * 20;
                                    else if (targetEnemy.type === 'creeper') points = 150 + (game.level - 1) * 15;
                                    
                                    
                                    game.score += points;
                                    game.enemiesDefeated++;
                                    game.enemies.splice(i, 1);
                                }
                            }
                        } else {
                            // Normal single enemy hit
                            if (enemy.element && enemy.element.parentNode) {
                                game.canvas.removeChild(enemy.element);
                            }
                            
                            let points = 100 + (game.level - 1) * 10;
                            if (enemy.type === 'enderman') points = 200 + (game.level - 1) * 20;
                            else if (enemy.type === 'creeper') points = 150 + (game.level - 1) * 15;
                            
                            game.score += points;
                            game.enemiesDefeated++;
                            game.enemies.splice(eIndex, 1);
                            
                            // Spreading fire effect
                            if (powerUps.active.spreadingFire && powerUps.active.spreadingFire > Date.now()) {
                                // Create visual fire spreading effect
                                createFireSpreadEffect(enemy.x + 20, enemy.y + 20);
                            }
                        }
                        
                        // Remove projectile
                        if (projectile.element && projectile.element.parentNode) {
                            game.canvas.removeChild(projectile.element);
                        }
                        game.projectiles.splice(pIndex, 1);
                        
                        sounds.enemyHit();
                        document.getElementById('score').textContent = game.score;
                        updateHighScore();
                        
                        break; // Exit inner loop since projectile is destroyed
                    }
                }
            }
            
            // Enemy projectiles vs player - iterate backwards
            for (let index = game.enemyProjectiles.length - 1; index >= 0; index--) {
                const projectile = game.enemyProjectiles[index];
                if (!projectile || !projectile.element) continue;
                
                if (projectile.x < game.player.x + 100 &&
                    projectile.x + 20 > game.player.x &&
                    projectile.y < game.player.y + 80 &&
                    projectile.y + 20 > game.player.y) {
                    
                    // Check for invincibility (Golden Apple)
                    const now = Date.now();
                    if (powerUps.active.invincibility && powerUps.active.invincibility > now) {
                        // Remove projectile but no damage
                        if (projectile.element && projectile.element.parentNode) {
                            game.canvas.removeChild(projectile.element);
                        }
                        game.enemyProjectiles.splice(index, 1);
                        continue;
                    }
                    
                    // Safe removal with existence check
                    if (projectile.element && projectile.element.parentNode) {
                        game.canvas.removeChild(projectile.element);
                    }
                    game.enemyProjectiles.splice(index, 1);
                    
                    sounds.hit();
                    
                    game.lives--;
                    document.getElementById('lives').textContent = game.lives;
                    
                    if (game.lives <= 0) {
                        gameOver();
                    }
                }
            }
            
            // Player vs power-ups - check collision
            for (let index = powerUps.items.length - 1; index >= 0; index--) {
                const powerUp = powerUps.items[index];
                if (!powerUp || !powerUp.element) continue;
                
                // Debug: Log positions
                // console.log('PowerUp:', powerUp.x, powerUp.y, 'Player:', game.player.x, game.player.y);
                
                // Simple overlap detection
                const playerCenterX = game.player.x + 50; // Player width is 100
                const playerCenterY = game.player.y + 40; // Player height is 80
                const powerUpCenterX = powerUp.x + 20; // PowerUp width is 40
                const powerUpCenterY = powerUp.y + 20; // PowerUp height is 40
                
                const distance = Math.sqrt(
                    Math.pow(playerCenterX - powerUpCenterX, 2) + 
                    Math.pow(playerCenterY - powerUpCenterY, 2)
                );
                
                if (distance < 60) { // Collection radius
                    console.log('PowerUp collected!', powerUp.type);
                    
                    // Collect power-up
                    if (powerUp.element && powerUp.element.parentNode) {
                        game.canvas.removeChild(powerUp.element);
                    }
                    powerUps.items.splice(index, 1);
                    
                    activatePowerUp(powerUp.type);
                    sounds.shoot(); // Collection sound
                    break; // Exit loop after collecting one power-up
                }
            }
            
            // Player projectiles vs power-ups (alternative collection method)
            for (let pIndex = game.projectiles.length - 1; pIndex >= 0; pIndex--) {
                const projectile = game.projectiles[pIndex];
                if (!projectile || !projectile.element) continue;
                
                for (let index = powerUps.items.length - 1; index >= 0; index--) {
                    const powerUp = powerUps.items[index];
                    if (!powerUp || !powerUp.element) continue;
                    
                    if (projectile.x < powerUp.x + 40 &&
                        projectile.x + 16 > powerUp.x &&
                        projectile.y < powerUp.y + 40 &&
                        projectile.y + 24 > powerUp.y) {
                        
                        // Collect power-up by shooting it
                        if (powerUp.element && powerUp.element.parentNode) {
                            game.canvas.removeChild(powerUp.element);
                        }
                        if (projectile.element && projectile.element.parentNode) {
                            game.canvas.removeChild(projectile.element);
                        }
                        
                        powerUps.items.splice(index, 1);
                        game.projectiles.splice(pIndex, 1);
                        
                        activatePowerUp(powerUp.type);
                        sounds.shoot(); // Collection sound
                        break;
                    }
                }
            }
            
            // Enemies reaching player
            game.enemies.forEach(enemy => {
                if (enemy.y + 60 >= game.player.y) {
                    gameOver();
                }
            });
        }

        // Level complete
        function levelComplete() {
            game.level++;
            document.getElementById('level').textContent = game.level;
            game.enemySpeed += 0.3;
            
            // Bonus life for completing level
            game.lives++;
            document.getElementById('lives').textContent = game.lives;
            
            // Bonus points for completing level
            const levelBonus = game.level * 500;
            game.score += levelBonus;
            document.getElementById('score').textContent = game.score;
            updateHighScore();
            
            createEnemies();
        }
        
        // Player wins (defeat all enemies in level)
        function playerWins() {
            gameStats.wins++;
            document.getElementById('wins').textContent = gameStats.wins;
            saveStats();
            levelComplete();
        }

        // Game over
        function gameOver() {
            game.gameRunning = false;
            document.getElementById('gameOver').style.display = 'block';
            sounds.gameOver();
            
            gameStats.losses++;
            document.getElementById('losses').textContent = gameStats.losses;
            updateHighScore();
            saveStats();
        }

        // Clear game entities only (not UI elements)
        function clearGameEntities() {
            // Remove all sprites but keep UI elements
            const sprites = game.canvas.querySelectorAll('.sprite');
            sprites.forEach(sprite => {
                if (sprite.parentNode) {
                    sprite.parentNode.removeChild(sprite);
                }
            });
        }

        // Restart game
        function restartGame() {
            // Clear only game entities, not UI
            clearGameEntities();
            
            // Reset game state
            game.player = null;
            game.enemies = [];
            game.projectiles = [];
            game.enemyProjectiles = [];
            game.score = 0;
            game.lives = 3;
            game.gameRunning = true;
            game.enemyDirection = 1;
            game.level = 1;
            game.enemySpeed = 1;
            game.enemiesDefeated = 0;
            
            // Update UI displays
            document.getElementById('score').textContent = game.score;
            document.getElementById('lives').textContent = game.lives;
            document.getElementById('level').textContent = game.level;
            document.getElementById('gameOver').style.display = 'none';
            
            // Reinitialize
            initPlayer();
            createEnemies();
        }

        // Event listeners
        document.addEventListener('keydown', (e) => {
            game.keys[e.code] = true;
            
            if (e.code === 'Space' && game.gameRunning) {
                e.preventDefault();
                shoot();
            }
            
            if (e.code === 'KeyR' && !game.gameRunning) {
                restartGame();
            }
            
        });

        document.addEventListener('keyup', (e) => {
            game.keys[e.code] = false;
        });


        // Game loop
        function gameLoop() {
            if (game.gameRunning) {
                movePlayer();
                moveEnemies();
                moveProjectiles();
                movePowerUps();
                moveFireSpreadEffects();
                enemyShoot();
                checkCollisions();
                spawnPowerUp();
                updatePowerUpDisplay();
                
                // Check win condition
                if (game.enemies.length === 0) {
                    playerWins();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Initialize game
        initUI();
        initPlayer();
        createEnemies();
        gameLoop();
    </script>
</body>
</html>